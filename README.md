# Rails on Docker

A simple setup to get you started with rails development on docker.

## Files

1. **.dockerignore**
Files/directories that will be left out during the container build.

2. **docker-compose.yml**  
Contains configurations to link the services(web/app service and the database/db service) and only expose the web app's port to users.

3. **Dockerfile**  
Provides the build context

4. **entrypoint.sh**  
Script containing the first insctructions to be run when the container is run

5. **Gemfile**  
Loads rails into the container.


## Get Started

- Clone repo.
- Cd into the repo directory.
- Run `docker-compose up --build`.
- Run `docker-compose down`. 
  
To generate a new rails project run.

- Run `docker-compose run --user $(id -u):$(id -g) web rails new . --force --database=postgresql -B --no-deps`.

### Notes

- `--user (id -u): (id -g)` -  resolves generated files/folder's ownership to the current user's id and group id respectively. This is to make sure that the files generated are owned by current user and not the default container user.  
- `--force` - overwrite conflicting files.  
- `--database=postgresql` - Configure rails to use postgresql instead of the default sqlite.  
- `-B` - skip bundle install, it's time consuming.


Rails expects a database to be running on `localhost`, you'll need to point it to the `db` container instead. You'll also need to change the database and username to align with the defaults set by the `postgres` image which we used to build the database container.

- Head over to `config/database.yml` and edit it to have the following.
    ```yml
        default: &default
        adapter: postgresql
        encoding: unicode
        host: db
        username: postgres
        password:
        pool: 5

        development:
        <<: *default
        database: myapp_development

        test:
        <<: *default
        database: myapp_test
    ```

Since the new rails project has populated the gemfile, shut down the services and build the images again.

- Run `docker-compose down`
- Run `docker-compose up --build` to boot up the app.
- navigate to http://localhost:3000

ActiveRecord: NoDatabaseError?
Create the database.
In a different terminal;

- Run `docker-compose exec app rails db:create`

## Cheat sheet.

1. To stop the application:
   `docker-compose down`
2. To restrat the application:
   `docker-compose up`
3. To rebuild the application:
   `docker-compose up --build`
4. To log into the container.
   `docker-compose run web bash`


## Permissions

Based on how Docker is set, you might run into *prmission denied* while trying to edit files generated by rails. In such a case you might want to check who owns the files by running `stat <path-to-file>`. If they are not owned by current user, you, you will need to change ownership running:`sudo chown -R $USER:$USER <path-to-file>`